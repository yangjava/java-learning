起因

做java开发有一些年头，常用的工具类相比大家都很熟悉，但是对于其中的实现机制，如果不曾细看，还真回答不上来，前日一友人问起StringBuffer和StringBuilder有什么区别，我自以对答如流，当问起StringBuffer扩容机制，我表示只知底层为数组，不知道如何扩容，甚是惭愧，于是我读了下相应的源码，希望把自己看到的能分享一下

扩容源码解析

首先我们看一下StringBuffer的继承结构

JAVA源码之你所不知道的StringBuffer扩容机制

StringBuffer继承结构

可以看到其实StringBuffer继承自AbstractStringBuilder并且实现了CharSequence和Serializable接口

JAVA源码之你所不知道的StringBuffer扩容机制

父类append方法

从上图可以看出，StringBuffer是调用的父类AbstractStringBuilder的append方法并且使用ensureCapacityInternal方法进行扩容，图中count变量为目前数组的长度，下面看下ensureCapacityInternal的实现

JAVA源码之你所不知道的StringBuffer扩容机制

扩容

上图我们可以看到新的数组长度为原来的数组长度的两倍加2，如果新的字符串长度加上原字符串的长度大于原来的数组长度的两倍加2则新数组的长度为新的字符串长度加上原字符串的长度，有点拗口，哈哈，不过大概这个意思